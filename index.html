<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stresskelima - Pengurusan Skrip & Cerita</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#020617" />

  <style>
    :root {
      --bg-main: #020617;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: #1f2937;
      --border-strong: #4b5563;
      --accent-start: #6366f1;
      --accent-end: #8b5cf6;
      --danger: #f97373;
      --input-bg: #020617;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background-color: var(--bg-main);
      color: var(--text-main);
    }

    .hidden { display: none !important; }

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pill-button {
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(255,255,255,0.05);
      color: var(--text-main);
      cursor: pointer;
    }

    .pill-button.primary {
      background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
      border: none;
      color: white;
    }

    main {
      padding: 1rem;
      max-width: 900px;
      margin: auto;
      width: 100%;
    }

    .card {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-subtle);
      padding: 1rem;
      border-radius: 0.8rem;
      margin-bottom: 1rem;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 60vh;
      overflow-y: auto;
    }

    .list-item {
      padding: 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }

    .textarea {
      width: 100%;
      min-height: 80px;
      background: var(--input-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 0.6rem;
      padding: 0.5rem;
      color: var(--text-main);
    }

    .watak-card {
      border: 1px solid var(--border-subtle);
      padding: 0.7rem;
      border-radius: 0.7rem;
      margin-bottom: 0.7rem;
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <header>
      <div>
        <div style="font-size:0.8rem;color:#9ca3af;">Stresskelima</div>
        <div style="font-size:1.1rem;">Pengurusan Skrip & Cerita</div>
      </div>

      <div style="display:flex;gap:0.5rem;">
        <button id="logSejarahButton" class="pill-button hidden">Log sejarah</button>
        <button id="loginButton" class="pill-button primary">Login Google</button>
        <button id="logoutButton" class="pill-button hidden">Logout</button>
      </div>
    </header>

    <main>

      <!-- LOGIN -->
      <section id="view-login" class="card">
        <h2>Log masuk akaun Google</h2>
        <p>Simpan skrip & cerita anda dengan selamat.</p>
        <button id="loginButtonMain" class="pill-button primary">Login dengan Google</button>
      </section>

      <!-- CERITA -->
      <section id="view-cerita" class="card hidden">
        <h2>Cerita</h2>
        <button id="addCeritaButton" class="pill-button primary">+ Tambah Cerita</button>
        <input id="searchCeritaInput" placeholder="Cari cerita..." class="textarea" style="min-height:40px;">
        <div id="ceritaList" class="list"></div>
        <div id="ceritaEmptyState">Belum ada cerita.</div>
      </section>

      <!-- SEASON -->
      <section id="view-season" class="card hidden">
        <h2>Season</h2>
        <div id="seasonSubtitle"></div>
        <button id="backToCeritaButton" class="pill-button">← Cerita</button>
        <button id="addSeasonButton" class="pill-button primary">+ Tambah Season</button>
        <input id="searchSeasonInput" placeholder="Cari season..." class="textarea" style="min-height:40px;">
        <div id="seasonList" class="list"></div>
        <div id="seasonEmptyState">Belum ada season.</div>
      </section>

      <!-- EPISOD -->
      <section id="view-episod" class="card hidden">
        <h2>Episod</h2>
        <div id="episodSubtitle"></div>
        <button id="backToSeasonButton" class="pill-button">← Season</button>
        <button id="addEpisodButton" class="pill-button primary">+ Tambah Episod</button>
        <input id="searchEpisodInput" placeholder="Cari episod..." class="textarea" style="min-height:40px;">
        <div id="episodList" class="list"></div>
        <div id="episodEmptyState">Belum ada episod.</div>
      </section>

      <!-- BABAK -->
      <section id="view-babak" class="card hidden">
        <h2>Babak</h2>
        <div id="babakSubtitle"></div>
        <button id="backToEpisodButton" class="pill-button">← Episod</button>
        <button id="addBabakButton" class="pill-button primary">+ Tambah Babak</button>
        <input id="searchBabakInput" placeholder="Cari babak..." class="textarea" style="min-height:40px;">
        <div id="babakList" class="list"></div>
        <div id="babakEmptyState">Belum ada babak.</div>
      </section>

      <!-- ACTION & DIALOG -->
      <section id="view-action-dialog" class="card hidden">
        <h2>Action & Dialog</h2>
        <div id="actionDialogSubtitle"></div>
        <button id="backToBabakButton" class="pill-button">← Babak</button>
        <button id="saveToLogButton" class="pill-button">Simpan ke Log</button>
        <button id="addWatakButton" class="pill-button primary">+ Tambah Watak</button>
        <div id="watakList"></div>
        <div id="watakEmptyState">Belum ada watak.</div>
      </section>

      <!-- LOG -->
      <section id="view-log" class="card hidden">
        <h2>Log Sejarah Babak</h2>
        <button id="closeLogButton" class="pill-button">Tutup</button>
        <div id="logList" class="list"></div>
        <div id="logEmptyState">Belum ada log.</div>
      </section>

    </main>
  </div>

<script type="module">

/* -----------------------------
   ✅ FIREBASE IMPORT & SETUP
------------------------------*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  getDocs,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDRN1NiTjXgZFQJPHVaTDa8pWKxgoU1wVI",
  authDomain: "stresskelima.firebaseapp.com",
  projectId: "stresskelima",
  storageBucket: "stresskelima.firebasestorage.app",
  messagingSenderId: "415923073268",
  appId: "1:415923073268:web:b255be14e086b109146ea1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

/* -----------------------------
   ✅ DOM ELEMENTS
------------------------------*/
const viewLogin = document.getElementById("view-login");
const viewCerita = document.getElementById("view-cerita");
const viewSeason = document.getElementById("view-season");
const viewEpisod = document.getElementById("view-episod");
const viewBabak = document.getElementById("view-babak");
const viewActionDialog = document.getElementById("view-action-dialog");
const viewLog = document.getElementById("view-log");

const loginButton = document.getElementById("loginButton");
const loginButtonMain = document.getElementById("loginButtonMain");
const logoutButton = document.getElementById("logoutButton");
const logSejarahButton = document.getElementById("logSejarahButton");

const addCeritaButton = document.getElementById("addCeritaButton");
const searchCeritaInput = document.getElementById("searchCeritaInput");
const ceritaList = document.getElementById("ceritaList");
const ceritaEmptyState = document.getElementById("ceritaEmptyState");

const backToCeritaButton = document.getElementById("backToCeritaButton");
const seasonSubtitle = document.getElementById("seasonSubtitle");
const addSeasonButton = document.getElementById("addSeasonButton");
const searchSeasonInput = document.getElementById("searchSeasonInput");
const seasonList = document.getElementById("seasonList");
const seasonEmptyState = document.getElementById("seasonEmptyState");

const backToSeasonButton = document.getElementById("backToSeasonButton");
const episodSubtitle = document.getElementById("episodSubtitle");
const addEpisodButton = document.getElementById("addEpisodButton");
const searchEpisodInput = document.getElementById("searchEpisodInput");
const episodList = document.getElementById("episodList");
const episodEmptyState = document.getElementById("episodEmptyState");

const backToEpisodButton = document.getElementById("backToEpisodButton");
const babakSubtitle = document.getElementById("babakSubtitle");
const addBabakButton = document.getElementById("addBabakButton");
const searchBabakInput = document.getElementById("searchBabakInput");
const babakList = document.getElementById("babakList");
const babakEmptyState = document.getElementById("babakEmptyState");

const backToBabakButton = document.getElementById("backToBabakButton");
const actionDialogSubtitle = document.getElementById("actionDialogSubtitle");
const saveToLogButton = document.getElementById("saveToLogButton");
const addWatakButton = document.getElementById("addWatakButton");
const watakList = document.getElementById("watakList");
const watakEmptyState = document.getElementById("watakEmptyState");

const closeLogButton = document.getElementById("closeLogButton");
const logList = document.getElementById("logList");
const logEmptyState = document.getElementById("logEmptyState");

/* -----------------------------
   ✅ GLOBAL STATE
------------------------------*/
let currentUser = null;
let currentCerita = null;
let currentSeason = null;
let currentEpisod = null;
let currentBabak = null;

/* -----------------------------
   ✅ VIEW SWITCHER
------------------------------*/
function showView(v) {
  [
    viewLogin, viewCerita, viewSeason, viewEpisod,
    viewBabak, viewActionDialog, viewLog
  ].forEach(x => x.classList.add("hidden"));

  v.classList.remove("hidden");
}

/* -----------------------------
   ✅ FIRESTORE PATH HELPERS
------------------------------*/
function pathCerita() {
  return collection(db, "users", currentUser.uid, "cerita");
}
function pathSeason() {
  return collection(db, "users", currentUser.uid, "cerita", currentCerita.id, "seasons");
}
function pathEpisod() {
  return collection(db, "users", currentUser.uid, "cerita", currentCerita.id, "seasons", currentSeason.id, "episod");
}
function pathBabak() {
  return collection(db, "users", currentUser.uid, "cerita", currentCerita.id, "seasons", currentSeason.id, "episod", currentEpisod.id, "babak");
}
function pathWatak() {
  return collection(db, "users", currentUser.uid, "cerita", currentCerita.id, "seasons", currentSeason.id, "episod", currentEpisod.id, "babak", currentBabak.id, "watak");
}
function pathLogs() {
  return collection(db, "users", currentUser.uid, "logs");
}

/* -----------------------------
   ✅ DATE FORMAT (Malaysia)
------------------------------*/
function formatMsDate(date) {
  const days = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"];
  const months = ["Jan","Feb","Mac","Apr","Mei","Jun","Jul","Ogos","Sep","Okt","Nov","Dis"];
  let h = date.getHours();
  const m = date.getMinutes().toString().padStart(2,"0");
  const suffix = h >= 12 ? "petang" : "pagi";
  if (h === 0) h = 12;
  else if (h > 12) h -= 12;
  return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}, ${h}:${m} ${suffix}`;
}

/* -----------------------------
   ✅ AUTH HANDLING
------------------------------*/
async function signIn() {
  await signInWithPopup(auth, provider);
}

async function signOutUser() {
  await signOut(auth);
}

loginButton.addEventListener("click", signIn);
loginButtonMain.addEventListener("click", signIn);
logoutButton.addEventListener("click", signOutUser);

onAuthStateChanged(auth, user => {
  currentUser = user;

  if (user) {
    showView(viewCerita);
    subscribeCerita();

    loginButton.classList.add("hidden");
    loginButtonMain.classList.add("hidden");
    logoutButton.classList.remove("hidden");
    logSejarahButton.classList.remove("hidden");

  } else {
    showView(viewLogin);

    logoutButton.classList.add("hidden");
    logSejarahButton.classList.add("hidden");
  }
});

/* -----------------------------
   ✅ CERITA (LIST, ADD, EDIT, DELETE)
------------------------------*/

let unsubCerita = null;

function subscribeCerita() {
  if (!currentUser) return;
  if (unsubCerita) unsubCerita();

  unsubCerita = onSnapshot(pathCerita(), snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCerita(data);
  });
}

function renderCerita(list) {
  ceritaList.innerHTML = "";
  const term = searchCeritaInput.value.toLowerCase();

  const filtered = list.filter(x => x.nama.toLowerCase().includes(term));

  if (filtered.length === 0) ceritaEmptyState.classList.remove("hidden");
  else ceritaEmptyState.classList.add("hidden");

  filtered.forEach(c => {
    const item = document.createElement("div");
    item.className = "list-item";

    const left = document.createElement("div");
    left.textContent = c.nama;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "0.3rem";

    const editBtn = document.createElement("button");
    editBtn.className = "pill-button";
    editBtn.textContent = "Edit";
    editBtn.onclick = async (e) => {
      e.stopPropagation();
      const nama = prompt("Nama baru:", c.nama);
      if (!nama) return;
      await updateDoc(doc(pathCerita(), c.id), { nama });
    };

    const delBtn = document.createElement("button");
    delBtn.className = "pill-button";
    delBtn.textContent = "Buang";
    delBtn.onclick = async (e) => {
      e.stopPropagation();
      if (!confirm("Buang cerita & semua anaknya?")) return;
      await deleteCeritaTree(c.id);
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    item.appendChild(left);
    item.appendChild(right);

    item.onclick = () => openSeason(c);

    ceritaList.appendChild(item);
  });
}

searchCeritaInput.addEventListener("input", () => subscribeCerita());

addCeritaButton.addEventListener("click", async () => {
  const nama = prompt("Nama cerita:");
  if (!nama) return;
  await addDoc(pathCerita(), { nama, createdAt: serverTimestamp() });
});

/* -----------------------------
   ✅ DELETE TREE (CERITA → SEASON → EPISOD → BABAK → WATAK)
------------------------------*/

async function deleteCeritaTree(ceritaId) {
  const seasonSnap = await getDocs(collection(db, "users", currentUser.uid, "cerita", ceritaId, "seasons"));
  for (const s of seasonSnap.docs) {
    await deleteSeasonTree(ceritaId, s.id);
  }
  await deleteDoc(doc(pathCerita(), ceritaId));
}

async function deleteSeasonTree(ceritaId, seasonId) {
  const episodSnap = await getDocs(collection(db, "users", currentUser.uid, "cerita", ceritaId, "seasons", seasonId, "episod"));
  for (const e of episodSnap.docs) {
    await deleteEpisodTree(ceritaId, seasonId, e.id);
  }
  await deleteDoc(doc(pathSeason(), seasonId));
}

async function deleteEpisodTree(ceritaId, seasonId, episodId) {
  const babakSnap = await getDocs(collection(db, "users", currentUser.uid, "cerita", ceritaId, "seasons", seasonId, "episod", episodId, "babak"));
  for (const b of babakSnap.docs) {
    await deleteBabakTree(ceritaId, seasonId, episodId, b.id);
  }
  await deleteDoc(doc(pathEpisod(), episodId));
}

async function deleteBabakTree(ceritaId, seasonId, episodId, babakId) {
  const watakSnap = await getDocs(collection(db, "users", currentUser.uid, "cerita", ceritaId, "seasons", seasonId, "episod", episodId, "babak", babakId, "watak"));
  for (const w of watakSnap.docs) {
    await deleteDoc(w.ref);
  }
  await deleteDoc(doc(pathBabak(), babakId));
}

/* -----------------------------
   ✅ SEASON
------------------------------*/

let unsubSeason = null;

function openSeason(c) {
  currentCerita = c;
  seasonSubtitle.textContent = c.nama;
  showView(viewSeason);
  subscribeSeason();
}

function subscribeSeason() {
  if (unsubSeason) unsubSeason();

  unsubSeason = onSnapshot(pathSeason(), snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderSeason(data);
  });
}

function renderSeason(list) {
  seasonList.innerHTML = "";
  const term = searchSeasonInput.value.toLowerCase();

  const filtered = list.filter(x => x.nama.toLowerCase().includes(term));

  if (filtered.length === 0) seasonEmptyState.classList.remove("hidden");
  else seasonEmptyState.classList.add("hidden");

  filtered.forEach(s => {
    const item = document.createElement("div");
    item.className = "list-item";

    const left = document.createElement("div");
    left.textContent = s.nama;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "0.3rem";

    const editBtn = document.createElement("button");
    editBtn.className = "pill-button";
    editBtn.textContent = "Edit";
    editBtn.onclick = async (e) => {
      e.stopPropagation();
      const nama = prompt("Nama baru:", s.nama);
      if (!nama) return;
      await updateDoc(doc(pathSeason(), s.id), { nama });
    };

    const delBtn = document.createElement("button");
    delBtn.className = "pill-button";
    delBtn.textContent = "Buang";
    delBtn.onclick = async (e) => {
      e.stopPropagation();
      if (!confirm("Buang season & semua anaknya?")) return;
      await deleteSeasonTree(currentCerita.id, s.id);
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    item.appendChild(left);
    item.appendChild(right);

    item.onclick = () => openEpisod(s);

    seasonList.appendChild(item);
  });
}

searchSeasonInput.addEventListener("input", () => subscribeSeason());

addSeasonButton.addEventListener("click", async () => {
  const nama = prompt("Nama season:");
  if (!nama) return;
  await addDoc(pathSeason(), { nama, createdAt: serverTimestamp() });
});

backToCeritaButton.addEventListener("click", () => {
  showView(viewCerita);
});

/* -----------------------------
   ✅ EPISOD
------------------------------*/

let unsubEpisod = null;

function openEpisod(s) {
  currentSeason = s;
  episodSubtitle.textContent = `${s.nama} • ${currentCerita.nama}`;
  showView(viewEpisod);
  subscribeEpisod();
}

function subscribeEpisod() {
  if (unsubEpisod) unsubEpisod();

  unsubEpisod = onSnapshot(pathEpisod(), snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderEpisod(data);
  });
}

function renderEpisod(list) {
  episodList.innerHTML = "";
  const term = searchEpisodInput.value.toLowerCase();

  const filtered = list.filter(x => x.nama.toLowerCase().includes(term));

  if (filtered.length === 0) episodEmptyState.classList.remove("hidden");
  else episodEmptyState.classList.add("hidden");

  filtered.forEach(e => {
    const item = document.createElement("div");
    item.className = "list-item";

    const left = document.createElement("div");
    left.textContent = e.nama;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "0.3rem";

    const editBtn = document.createElement("button");
    editBtn.className = "pill-button";
    editBtn.textContent = "Edit";
    editBtn.onclick = async (ev) => {
      ev.stopPropagation();
      const nama = prompt("Nama baru:", e.nama);
      if (!nama) return;
      await updateDoc(doc(pathEpisod(), e.id), { nama });
    };

    const delBtn = document.createElement("button");
    delBtn.className = "pill-button";
    delBtn.textContent = "Buang";
    delBtn.onclick = async (ev) => {
      ev.stopPropagation();
      if (!confirm("Buang episod & semua anaknya?")) return;
      await deleteEpisodTree(currentCerita.id, currentSeason.id, e.id);
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    item.appendChild(left);
    item.appendChild(right);

    item.onclick = () => openBabak(e);

    episodList.appendChild(item);
  });
}

searchEpisodInput.addEventListener("input", () => subscribeEpisod());

addEpisodButton.addEventListener("click", async () => {
  const nama = prompt("Nama episod:");
  if (!nama) return;
  await addDoc(pathEpisod(), { nama, createdAt: serverTimestamp() });
});

backToSeasonButton.addEventListener("click", () => {
  showView(viewSeason);
});

/* -----------------------------
   ✅ BABAK
------------------------------*/

let unsubBabak = null;

function openBabak(e) {
  currentEpisod = e;
  babakSubtitle.textContent = `${e.nama} • ${currentSeason.nama} • ${currentCerita.nama}`;
  showView(viewBabak);
  subscribeBabak();
}

function subscribeBabak() {
  if (unsubBabak) unsubBabak();

  unsubBabak = onSnapshot(pathBabak(), snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderBabak(data);
  });
}

function renderBabak(list) {
  babakList.innerHTML = "";
  const term = searchBabakInput.value.toLowerCase();

  const filtered = list.filter(x => x.nama.toLowerCase().includes(term));

  if (filtered.length === 0) babakEmptyState.classList.remove("hidden");
  else babakEmptyState.classList.add("hidden");

  filtered.forEach(b => {
    const item = document.createElement("div");
    item.className = "list-item";

    const left = document.createElement("div");
    left.textContent = b.nama;

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "0.3rem";

    const editBtn = document.createElement("button");
    editBtn.className = "pill-button";
    editBtn.textContent = "Edit";
    editBtn.onclick = async (ev) => {
      ev.stopPropagation();
      const nama = prompt("Nama baru:", b.nama);
      if (!nama) return;
      await updateDoc(doc(pathBabak(), b.id), { nama });
    };

    const delBtn = document.createElement("button");
    delBtn.className = "pill-button";
    delBtn.textContent = "Buang";
    delBtn.onclick = async (ev) => {
      ev.stopPropagation();
      if (!confirm("Buang babak & semua watak?")) return;
      await deleteBabakTree(currentCerita.id, currentSeason.id, currentEpisod.id, b.id);
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    item.appendChild(left);
    item.appendChild(right);

    item.onclick = () => openActionDialog(b);

    babakList.appendChild(item);
  });
}

searchBabakInput.addEventListener("input", () => subscribeBabak());

addBabakButton.addEventListener("click", async () => {
  const nama = prompt("Nama babak:");
  if (!nama) return;
  await addDoc(pathBabak(), { nama, createdAt: serverTimestamp() });
});

backToEpisodButton.addEventListener("click", () => {
  showView(viewEpisod);
});

/* -----------------------------
   ✅ ACTION & DIALOG (WATAK)
------------------------------*/

let unsubWatak = null;

function openActionDialog(b) {
  currentBabak = b;
  actionDialogSubtitle.textContent =
    `${b.nama} • ${currentEpisod.nama} • ${currentSeason.nama} • ${currentCerita.nama}`;

  showView(viewActionDialog);
  subscribeWatak();
}

function subscribeWatak() {
  if (unsubWatak) unsubWatak();

  unsubWatak = onSnapshot(pathWatak(), snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderWatak(data);
  });
}

function renderWatak(list) {
  watakList.innerHTML = "";

  if (list.length === 0) {
    watakEmptyState.classList.remove("hidden");
  } else {
    watakEmptyState.classList.add("hidden");
  }

  list.forEach(w => {
    const card = document.createElement("div");
    card.className = "watak-card";

    /* -----------------------------
       ✅ Header (Nama Watak + Simpan + Buang)
    ------------------------------*/
    const header = document.createElement("div");
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.marginBottom = "0.5rem";

    const nameInput = document.createElement("input");
    nameInput.value = w.nama;
    nameInput.className = "textarea";
    nameInput.style.minHeight = "35px";
    nameInput.style.resize = "none";

    const headerBtns = document.createElement("div");
    headerBtns.style.display = "flex";
    headerBtns.style.gap = "0.3rem";

    const saveBtn = document.createElement("button");
    saveBtn.className = "pill-button";
    saveBtn.textContent = "Simpan";

    saveBtn.onclick = async () => {
      await updateDoc(doc(pathWatak(), w.id), {
        nama: nameInput.value,
        action: actionInput.value,
        dialog: dialogInput.value,
        updatedAt: serverTimestamp()
      });

      saveBtn.textContent = "Disimpan";
      setTimeout(() => saveBtn.textContent = "Simpan", 900);
    };

    const delBtn = document.createElement("button");
    delBtn.className = "pill-button";
    delBtn.textContent = "Buang";

    delBtn.onclick = async () => {
      if (!confirm("Buang watak ini?")) return;
      await deleteDoc(doc(pathWatak(), w.id));
    };

    headerBtns.appendChild(saveBtn);
    headerBtns.appendChild(delBtn);

    header.appendChild(nameInput);
    header.appendChild(headerBtns);

    /* -----------------------------
       ✅ Action & Dialog Textarea
    ------------------------------*/
    const actionInput = document.createElement("textarea");
    actionInput.className = "textarea";
    actionInput.placeholder = "Action...";
    actionInput.value = w.action || "";

    const dialogInput = document.createElement("textarea");
    dialogInput.className = "textarea";
    dialogInput.placeholder = "Dialog...";
    dialogInput.value = w.dialog || "";

    card.appendChild(header);
    card.appendChild(actionInput);
    card.appendChild(dialogInput);

    watakList.appendChild(card);
  });
}

addWatakButton.addEventListener("click", async () => {
  const nama = prompt("Nama watak:");
  if (!nama) return;

  await addDoc(pathWatak(), {
    nama,
    action: "",
    dialog: "",
    createdAt: serverTimestamp()
  });
});

backToBabakButton.addEventListener("click", () => {
  showView(viewBabak);
});

/* -----------------------------
   ✅ SIMPAN KE LOG
------------------------------*/

saveToLogButton.addEventListener("click", async () => {
  if (!currentCerita || !currentSeason || !currentEpisod || !currentBabak) {
    alert("Ralat: data tidak lengkap.");
    return;
  }

  const now = new Date();
  const formatted = `${currentCerita.nama} • ${currentSeason.nama} • ${currentEpisod.nama} • ${currentBabak.nama} • ${formatMsDate(now)}`;

  await addDoc(pathLogs(), {
    ceritaName: currentCerita.nama,
    seasonName: currentSeason.nama,
    episodName: currentEpisod.nama,
    babakName: currentBabak.nama,
    timestamp: serverTimestamp(),
    formatted
  });

  alert("Berjaya disimpan ke log.");
});

/* -----------------------------
   ✅ LOG VIEW
------------------------------*/

let unsubLogs = null;

logSejarahButton.addEventListener("click", () => {
  showView(viewLog);
  subscribeLogs();
});

function subscribeLogs() {
  if (unsubLogs) unsubLogs();

  unsubLogs = onSnapshot(pathLogs(), snap => {
    const data = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .sort((a, b) => (b.timestamp?.toMillis?.() || 0) - (a.timestamp?.toMillis?.() || 0));

    renderLogs(data);
  });
}

function renderLogs(list) {
  logList.innerHTML = "";

  if (list.length === 0) {
    logEmptyState.classList.remove("hidden");
  } else {
    logEmptyState.classList.add("hidden");
  }

  list.forEach(l => {
    const item = document.createElement("div");
    item.className = "list-item";

    const left = document.createElement("div");
    left.textContent = l.formatted;

    item.appendChild(left);
    logList.appendChild(item);
  });
}

closeLogButton.addEventListener("click", () => {
  showView(viewCerita);
});

/* -----------------------------
   ✅ REGISTER SERVICE WORKER
------------------------------*/

if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js")
      .catch(err => console.error("SW registration failed:", err));
  });
}

</script>

</body>
</html>
